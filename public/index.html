<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TikTok Embed Search</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin: 0; padding: 18px; }
    .row { display:flex; gap:8px; margin-bottom:12px; }
    input { flex:1; padding:10px; font-size:16px; border-radius:8px; border:1px solid #ddd; }
    button { padding:10px 14px; border-radius:8px; cursor:pointer; }
    #results { display:flex; flex-direction:column; gap:18px; margin-top:12px; }
    .embed { max-width:640px; }
    .note { color:#666; font-size:14px; }
  </style>
</head>
<body>
  <h2>TikTok Embed Search</h2>
  <div class="row">
    <input id="q" placeholder="Search TikTok (e.g., 'cats', 'dance challenge', '@username')" />
    <button id="go">Search</button>
  </div>
  <div id="status" class="note">Search returns official TikTok embed snippets (using oEmbed) where available.</div>
  <div id="results"></div>

  <script>
    async function search(q) {
      const r = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
      if (!r.ok) {
        const body = await r.json().catch(()=>({}));
        throw new Error(body.error || r.statusText);
      }
      return r.json();
    }

    const qInput = document.getElementById('q');
    const btn = document.getElementById('go');
    const results = document.getElementById('results');
    const status = document.getElementById('status');

    btn.addEventListener('click', async () => {
      const q = qInput.value.trim();
      if (!q) return;
      status.textContent = 'Searchingâ€¦';
      results.innerHTML = '';
      try {
        const data = await search(q);
        if (!data.results || data.results.length === 0) {
          status.textContent = 'No results or no embeddable videos found.';
          return;
        }
        status.textContent = `Found ${data.results.length} embeddable videos.`;
        // Insert embed HTML into page
        for (const r of data.results) {
          const wrapper = document.createElement('div');
          wrapper.className = 'embed';
          // embedHtml usually contains a <blockquote class="tiktok-embed">... plus script
          wrapper.innerHTML = r.embedHtml;
          results.appendChild(wrapper);
        }
        // Load TikTok embed script (will initialize blockquotes)
        const existing = document.querySelector('script[src="https://www.tiktok.com/embed.js"]');
        if (!existing) {
          const s = document.createElement('script');
          s.src = "https://www.tiktok.com/embed.js";
          s.async = true;
          document.body.appendChild(s);
        } else {
          // If already loaded, try re-run initialization (TikTok script usually auto-inits on load)
          // There's no official public 'reinit' exposed; adding a small timeout to allow it to render.
        }
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
      }
    });

    // quick enter-to-search
    qInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') btn.click();
    });
  </script>
</body>
</html>
